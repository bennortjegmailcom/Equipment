
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Utilization Tracker</title>
    <style>
        :root {
            --mechanical: #FF9AA2;
            --electrical: #FFB7B2;
            --operations: #FFDAC1;
            --technicians: #E2F0CB;
            --instrumentation: #B5EAD7;
            --management: #C7CEEA;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .selection-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            display: none;
            z-index: 100;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #2c3e50;
            color: white;
            border-radius: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 8px 15px;
            background-color: #34495e;
            border-radius: 5px;
            cursor: pointer;
        }

        .tab.active {
            background-color: #1abc9c;
        }

        .timeline-container {
            overflow-x: auto;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
        }

        .equipment-rows {
            display: flex;
            flex-direction: column;
        }

        .equipment-row {
            display: flex;
            min-height: 60px;
            border-bottom: 1px solid #eee;
            align-items: stretch;
        }

        .equipment-label {
            min-width: 120px;
            padding: 10px;
            font-weight: bold;
            background-color: #ecf0f1;
            display: flex;
            align-items: center;
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .shift-section {
            display: flex;
            flex-direction: column;
            border-right: 2px solid #bdc3c7;
        }

        .shift-header {
            font-weight: bold;
            padding: 3px 5px;
            background-color: #34495e;
            color: white;
            text-align: center;
            font-size: 11px;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-header {
            display: flex;
            background-color: #ecf0f1;
            font-size: 8px;
            min-height: 15px;
        }

        .time-slot {
            width: 6px;
            text-align: center;
            padding: 0;
            border-right: 1px solid #eee;
            font-size: 7px;
            flex-shrink: 0;
            position: relative;
            box-sizing: border-box;
        }

        .time-slot.hour-mark {
            border-right: 2px solid #333;
            font-weight: bold;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            background-color: #f8f9fa;
            width: 6px;
        }

        .time-blocks {
            display: flex;
        }

        .time-block {
            width: 6px;
            height: 40px;
            border-right: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .time-block:hover {
            background-color: #f0f0f0;
        }

        .time-block.selected {
            background-color: #3498db;
        }

        .time-block.hour-start {
            border-left: 2px solid #333;
        }

        .time-block.booked {
            opacity: 0.7;
        }

        .booking-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 400px;
            max-width: 90%;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .system-icons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .system-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #ddd;
        }

        .system-icon.selected {
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .meeting-view {
            display: none;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
        }

        .booking-card {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .booking-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .booking-card p {
            margin: 5px 0;
            font-size: 14px;
        }

        .admin-panel {
            display: none;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
        }

        .color-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .admin-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .relation-form {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .relations-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            padding: 10px;
        }

        .relation-item {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            position: relative;
        }

        .relation-item h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .relation-details {
            font-size: 14px;
            line-height: 1.5;
        }

        .relation-details strong {
            color: #34495e;
        }

        .relation-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-edit {
            background-color: #f39c12;
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-up, .btn-down {
            background-color: #95a5a6;
            color: white;
        }

        .relation-edit-form {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .relation-edit-form input, .relation-edit-form select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="selection-info" id="selection-info">
            <div>Equipment: <span id="selected-equipment"></span></div>
            <div>Start: <span id="start-time"></span></div>
            <div>End: <span id="end-time"></span></div>
        </div>

        <div class="header">
            <h1>Equipment Utilization Tracker</h1>
            <div class="tabs">
                <div class="tab active" onclick="showTab('tracker')">Tracker</div>
                <div class="tab" onclick="showTab('meeting')">Meeting View</div>
                <div class="tab" onclick="showTab('admin')">Admin</div>
            </div>
        </div>

        <div id="tracker" class="timeline-container">
            <div class="equipment-rows" id="equipment-rows"></div>
        </div>

        <div id="meeting" class="meeting-view">
            <h2>Morning Meeting Overview</h2>
            <div id="booking-cards"></div>
        </div>

        <div id="admin" class="admin-panel">
            <h2>Admin Panel</h2>
            
            <div class="admin-section">
                <h3>Equipment Relations Management</h3>
                <div class="form-group">
                    <label>Add Equipment Relation</label>
                    <div class="relation-form">
                        <select id="relation-equipment" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Select Equipment</option>
                            <option value="stack-811">Stack 811</option>
                            <option value="stack-812">Stack 812</option>
                            <option value="stack-813">Stack 813</option>
                            <option value="gg1-filters">GG1 Filters</option>
                            <option value="810-3000">810 3000</option>
                            <option value="810-3100">810 3100</option>
                            <option value="5810800">5810800</option>
                        </select>
                        <input type="text" id="relation-systems" placeholder="System types (comma separated): conveyor, pump, pipe" style="width: 100%; margin-bottom: 10px;">
                        <select id="relation-section" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Select Responsible Section</option>
                            <option value="mechanical">Mechanical</option>
                            <option value="electrical">Electrical</option>
                            <option value="operations">Operations</option>
                            <option value="technicians">Technicians</option>
                            <option value="instrumentation">Instrumentation</option>
                            <option value="management">Management</option>
                        </select>
                        <input type="text" id="relation-faults" placeholder="Probable faults (comma separated): trip, power failure, run skew" style="width: 100%; margin-bottom: 10px;">
                        <button id="add-relation" class="btn-primary">Add Relation</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Equipment Relations List</label>
                    <div id="relations-list" class="relations-container">
                        <p>No relations added yet.</p>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h3>Equipment Management</h3>
                <div class="form-group">
                    <label>Load Equipment Relations</label>
                    <input type="file" id="relations-upload">
                    <button id="load-relations" class="btn-primary" style="margin-top: 10px;">Load Relations</button>
                </div>

                <div class="form-group">
                    <label>Add New Equipment</label>
                    <input type="text" id="new-equipment" placeholder="Equipment name">
                    <button id="add-equipment" class="btn-primary" style="margin-top: 10px;">Add Equipment</button>
                </div>

                <div class="form-group">
                    <label>Add New Fault Type</label>
                    <input type="text" id="new-fault" placeholder="Fault description">
                    <button id="add-fault" class="btn-primary" style="margin-top: 10px;">Add Fault</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="booking-modal" id="booking-modal">
            <h3>Add Equipment Booking</h3>
            <div class="form-group">
                <label>Equipment</label>
                <select id="equipment-select" class="equipment-select">
                    <option value="">Select Equipment</option>
                    <option value="stack-811">Stack 811</option>
                    <option value="stack-812">Stack 812</option>
                    <option value="stack-813">Stack 813</option>
                    <option value="gg1-filters">GG1 Filters</option>
                    <option value="810-3000">810 3000</option>
                    <option value="810-3100">810 3100</option>
                    <option value="5810800">5810800</option>
                </select>
            </div>

            <div class="form-group">
                <label>System Type</label>
                <div class="system-icons">
                    <div class="system-icon pipe selected" data-system="pipe" onclick="selectSystem(this, 'pipe')">Pipe</div>
                    <div class="system-icon pump" data-system="pump" onclick="selectSystem(this, 'pump')">Pump</div>
                    <div class="system-icon conveyor" data-system="conveyor" onclick="selectSystem(this, 'conveyor')">Conveyor</div>
                </div>
            </div>

            <div class="form-group">
                <label>Responsible Section</label>
                <select id="section-select">
                    <option value="">Select Section</option>
                    <option value="mechanical">Mechanical</option>
                    <option value="electrical">Electrical</option>
                    <option value="operations">Operations</option>
                    <option value="technicians">Technicians</option>
                    <option value="instrumentation">Instrumentation</option>
                    <option value="management">Management</option>
                </select>
            </div>

            <div class="form-group">
                <label>Fault Type</label>
                <select id="fault-select">
                    <option value="">Select Fault</option>
                    <option value="leakage">Leakage</option>
                    <option value="blockage">Blockage</option>
                    <option value="wear">Wear</option>
                    <option value="failure">Failure</option>
                    <option value="maintenance">Scheduled Maintenance</option>
                </select>
            </div>

            <div class="form-group">
                <label>Comments (max 20 words)</label>
                <textarea id="comments" rows="3" maxlength="100"></textarea>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="saveBooking()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let bookings = [];
        let selectedTimeBlocks = [];
        let selectedSystem = 'pipe';
        let currentTab = 'tracker';
        let equipmentRelations = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEquipmentRows();
            setupEventListeners();
            showTab('tracker');
        });

        // Set up equipment rows with time blocks for both shifts
        function initializeEquipmentRows() {
            const equipmentRows = document.getElementById('equipment-rows');
            const equipmentList = [
                'Stack 811', 'Stack 812', 'Stack 813',
                'GG1 Filters', '810 3000', '810 3100', '5810800'
            ];

            equipmentList.forEach(equipment => {
                const row = document.createElement('div');
                row.className = 'equipment-row';

                // Equipment label
                const label = document.createElement('div');
                label.className = 'equipment-label';
                label.textContent = equipment;
                label.dataset.equipment = equipment.toLowerCase().replace(' ', '-');
                row.appendChild(label);

                // Day Shift Section (6:00-18:00)
                const daySection = createShiftSection('Day Shift (6:00-18:00)', 6, 18, equipment);
                row.appendChild(daySection);

                // Night Shift Section (18:00-6:00)
                const nightSection = createShiftSection('Night Shift (18:00-6:00)', 18, 30, equipment); // 30 represents 6AM next day
                row.appendChild(nightSection);

                equipmentRows.appendChild(row);
            });
        }

        function createShiftSection(shiftTitle, startHour, endHour, equipment) {
            const section = document.createElement('div');
            section.className = 'shift-section';

            // Shift header
            const header = document.createElement('div');
            header.className = 'shift-header';
            header.textContent = shiftTitle;
            section.appendChild(header);

            // Time header
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-header';
            
            // Time blocks container
            const timeBlocks = document.createElement('div');
            timeBlocks.className = 'time-blocks';

            // Calculate total blocks for this shift (12 hours * 12 blocks per hour = 144 blocks)
            const totalBlocks = 12 * 12; // 12 hours, 5-minute intervals = 12 blocks per hour
            let blockIndex = 0;

            // Create time slots and blocks with proper 1:1 alignment
            for (let hour = startHour; hour < startHour + 12; hour++) {
                const actualHour = hour >= 24 ? hour - 24 : hour; // Handle overnight shift
                
                for (let minute = 0; minute < 60; minute += 5) {
                    // Create time slot header for every 5-minute interval
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    
                    // Show time only at hour marks, empty for other intervals
                    if (minute === 0) {
                        timeSlot.textContent = `${actualHour.toString().padStart(2, '0')}:00`;
                        timeSlot.classList.add('hour-mark');
                    } else {
                        timeSlot.textContent = '';
                    }
                    timeHeader.appendChild(timeSlot);
                    
                    // Create time block
                    const block = document.createElement('div');
                    block.className = 'time-block';
                    
                    // Add hour-start class for more visible hour lines
                    if (minute === 0) {
                        block.classList.add('hour-start');
                    }
                    
                    block.dataset.index = blockIndex;
                    block.dataset.time = `${actualHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    block.dataset.equipment = equipment.toLowerCase().replace(' ', '-');
                    block.addEventListener('mousedown', startSelection);
                    block.addEventListener('mouseenter', extendSelection);
                    timeBlocks.appendChild(block);
                    
                    blockIndex++;
                }
            }

            section.appendChild(timeHeader);
            section.appendChild(timeBlocks);
            return section;
        }

        // Set up event listeners
        function setupEventListeners() {
            document.addEventListener('mouseup', endSelection);

            // Admin panel buttons
            document.getElementById('load-relations').addEventListener('click', loadRelations);
            document.getElementById('add-equipment').addEventListener('click', addEquipment);
            document.getElementById('add-fault').addEventListener('click', addFault);
            document.getElementById('add-relation').addEventListener('click', addRelation);
        }

        // Tab navigation
        function showTab(tabName) {
            document.getElementById(currentTab).style.display = 'none';
            document.querySelector(`.tab[onclick="showTab('${currentTab}')"]`).classList.remove('active');

            currentTab = tabName;
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'meeting') {
                updateMeetingView();
            }
        }

        // Time block selection
        let isSelecting = false;
        let selectionStartIndex = -1;
        let currentEquipment = '';

        function startSelection(e) {
            if (e.button !== 0) return; // Only left mouse button

            const block = e.target;
            
            if (block.classList.contains('booked')) {
                const bookingId = block.dataset.bookingId;
                showBookingDetails(bookingId);
                return;
            }

            isSelecting = true;
            selectedTimeBlocks = [];
            selectionStartIndex = parseInt(block.dataset.index);
            currentEquipment = block.dataset.equipment;

            // Clear all previous selections
            document.querySelectorAll('.time-block.selected').forEach(el => {
                el.classList.remove('selected');
            });

            block.classList.add('selected');
            selectedTimeBlocks.push({
                element: block,
                index: parseInt(block.dataset.index),
                equipment: currentEquipment,
                time: block.dataset.time
            });

            // Show selection info
            showSelectionInfo();

            e.preventDefault();
        }

        function extendSelection(e) {
            if (!isSelecting) return;

            const block = e.target;
            if (block.classList.contains('booked')) return;

            // Only allow selection within the same equipment and same shift section
            if (block.dataset.equipment !== currentEquipment) return;

            const currentIndex = parseInt(block.dataset.index);
            const shiftSection = block.closest('.shift-section');
            const blocksInSection = shiftSection.querySelectorAll('.time-block');
            
            // Clear selections in this section
            blocksInSection.forEach(el => {
                el.classList.remove('selected');
            });
            selectedTimeBlocks = [];

            // Calculate range within this shift section
            const startBlockInSection = Array.from(blocksInSection).find(b => parseInt(b.dataset.index) === selectionStartIndex);
            if (!startBlockInSection) return;

            const startIndexInSection = Array.from(blocksInSection).indexOf(startBlockInSection);
            const currentIndexInSection = Array.from(blocksInSection).indexOf(block);
            
            const start = Math.min(startIndexInSection, currentIndexInSection);
            const end = Math.max(startIndexInSection, currentIndexInSection);

            // Select blocks in range
            for (let i = start; i <= end; i++) {
                const b = blocksInSection[i];
                if (b && !b.classList.contains('booked')) {
                    b.classList.add('selected');
                    selectedTimeBlocks.push({
                        element: b,
                        index: parseInt(b.dataset.index),
                        equipment: currentEquipment,
                        time: b.dataset.time
                    });
                }
            }

            // Update selection info
            showSelectionInfo();
        }

        function endSelection() {
            if (!isSelecting) return;
            isSelecting = false;

            if (selectedTimeBlocks.length > 0) {
                openBookingModal();
            } else {
                hideSelectionInfo();
            }
        }

        // Modal functions
        function openBookingModal() {
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('booking-modal').style.display = 'block';

            // Pre-select the equipment based on the selected time blocks
            if (selectedTimeBlocks.length > 0) {
                const equipment = selectedTimeBlocks[0].equipment;
                document.getElementById('equipment-select').value = equipment;
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('booking-modal').style.display = 'none';

            // Clear selection
            selectedTimeBlocks.forEach(item => {
                item.element.classList.remove('selected');
            });
            selectedTimeBlocks = [];
            hideSelectionInfo();
            resetBookingForm();
        }

        function selectSystem(element, system) {
            document.querySelectorAll('.system-icon').forEach(icon => {
                icon.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedSystem = system;
        }

        function saveBooking() {
            const equipment = document.getElementById('equipment-select').value;
            const section = document.getElementById('section-select').value;
            const fault = document.getElementById('fault-select').value;
            const comments = document.getElementById('comments').value;

            if (!equipment || !section || !fault) {
                alert('Please fill in all required fields');
                return;
            }

            // Sort selected time blocks by time
            selectedTimeBlocks.sort((a, b) => a.time.localeCompare(b.time));

            // Create booking object
            const booking = {
                id: Date.now().toString(),
                equipment: equipment,
                system: selectedSystem,
                section: section,
                fault: fault,
                comments: comments,
                timeBlocks: selectedTimeBlocks.map(block => ({index: block.index, time: block.time})),
                startTime: selectedTimeBlocks[0].time,
                endTime: selectedTimeBlocks[selectedTimeBlocks.length - 1].time
            };

            bookings.push(booking);

            // Mark the selected time blocks as booked
            selectedTimeBlocks.forEach(blockInfo => {
                const block = blockInfo.element;
                if (block && !block.classList.contains('booked')) {
                    block.classList.add('booked');
                    block.classList.remove('selected');
                    block.dataset.bookingId = booking.id;
                    block.style.backgroundColor = getSectionColor(section);
                }
            });

            // Clear all selected blocks
            document.querySelectorAll('.time-block.selected').forEach(el => {
                el.classList.remove('selected');
            });

            closeModal();

            // Update meeting view if it's active
            if (currentTab === 'meeting') {
                updateMeetingView();
            }
        }

        function showBookingDetails(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;

            // Populate modal with booking details
            document.getElementById('equipment-select').value = booking.equipment;
            document.getElementById('section-select').value = booking.section;
            document.getElementById('fault-select').value = booking.fault;
            document.getElementById('comments').value = booking.comments;

            // Select the correct system icon
            document.querySelectorAll('.system-icon').forEach(icon => {
                icon.classList.remove('selected');
                if (icon.dataset.system === booking.system) {
                    icon.classList.add('selected');
                }
            });
            selectedSystem = booking.system;

            // Disable form controls (read-only view)
            document.getElementById('equipment-select').disabled = true;
            document.getElementById('section-select').disabled = true;
            document.getElementById('fault-select').disabled = true;
            document.getElementById('comments').disabled = true;
            document.querySelectorAll('.system-icon').forEach(icon => {
                icon.style.pointerEvents = 'none';
            });

            // Change button to "Close"
            const saveButton = document.querySelector('#booking-modal .btn-primary');
            saveButton.textContent = 'Close';
            saveButton.onclick = function() {
                closeModal();
                resetBookingForm();
            };

            // Show modal
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('booking-modal').style.display = 'block';
        }

        function resetBookingForm() {
            document.getElementById('equipment-select').value = '';
            document.getElementById('section-select').value = '';
            document.getElementById('fault-select').value = '';
            document.getElementById('comments').value = '';

            document.getElementById('equipment-select').disabled = false;
            document.getElementById('section-select').disabled = false;
            document.getElementById('fault-select').disabled = false;
            document.getElementById('comments').disabled = false;

            document.querySelectorAll('.system-icon').forEach(icon => {
                icon.style.pointerEvents = 'auto';
            });

            // Reset system selection to default (pipe)
            document.querySelectorAll('.system-icon').forEach(icon => {
                icon.classList.remove('selected');
            });
            document.querySelector('.system-icon.pipe').classList.add('selected');
            selectedSystem = 'pipe';

            // Reset button to "Save"
            const saveButton = document.querySelector('#booking-modal .btn-primary');
            saveButton.textContent = 'Save';
            saveButton.onclick = saveBooking;
        }

        // Meeting view functions
        function updateMeetingView() {
            const container = document.getElementById('booking-cards');
            container.innerHTML = '';

            if (bookings.length === 0) {
                container.innerHTML = '<p>No bookings have been created yet.</p>';
                return;
            }

            // Sort bookings by start time
            const sortedBookings = [...bookings].sort((a, b) => {
                return a.startTime.localeCompare(b.startTime);
            });

            sortedBookings.forEach((booking, index) => {
                const card = document.createElement('div');
                card.className = 'booking-card';
                card.dataset.bookingId = booking.id;

                const equipmentName = booking.equipment.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                card.innerHTML = `
                    <h3>Booking #${index + 1}: ${equipmentName} - ${booking.startTime} to ${booking.endTime}</h3>
                    <p><span class="color-indicator" style="background-color: ${getSectionColor(booking.section)}"></span>
                    System: ${booking.system.charAt(0).toUpperCase() + booking.system.slice(1)} |
                    Responsible: ${booking.section.charAt(0).toUpperCase() + booking.section.slice(1)}</p>
                    <p>Fault: ${booking.fault.charAt(0).toUpperCase() + booking.fault.slice(1)}</p>
                    <p>Comments: ${booking.comments || 'None'}</p>
                `;

                container.appendChild(card);
            });
        }

        // Admin functions
        function loadRelations() {
            const fileInput = document.getElementById('relations-upload');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    alert('Relations loaded successfully (simulated)');
                    fileInput.value = '';
                } catch (error) {
                    alert('Error loading relations: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function addEquipment() {
            const input = document.getElementById('new-equipment');
            const name = input.value.trim();

            if (!name) {
                alert('Please enter equipment name');
                return;
            }

            // Add to equipment dropdown
            const select = document.getElementById('equipment-select');
            const option = document.createElement('option');
            option.value = name.toLowerCase().replace(/\s+/g, '-');
            option.textContent = name;
            select.appendChild(option);

            // Add the new equipment to the equipment list and refresh
            const equipmentRows = document.getElementById('equipment-rows');
            
            // Create new equipment row
            const row = document.createElement('div');
            row.className = 'equipment-row';

            // Equipment label
            const label = document.createElement('div');
            label.className = 'equipment-label';
            label.textContent = name;
            label.dataset.equipment = name.toLowerCase().replace(/\s+/g, '-');
            row.appendChild(label);

            // Day Shift Section (6:00-18:00)
            const daySection = createShiftSection('Day Shift (6:00-18:00)', 6, 18, name);
            row.appendChild(daySection);

            // Night Shift Section (18:00-6:00)
            const nightSection = createShiftSection('Night Shift (18:00-6:00)', 18, 30, name);
            row.appendChild(nightSection);

            equipmentRows.appendChild(row);

            input.value = '';
            alert(`Equipment "${name}" added successfully`);
        }

        function addFault() {
            const input = document.getElementById('new-fault');
            const name = input.value.trim();

            if (!name) {
                alert('Please enter fault description');
                return;
            }

            // Add to fault dropdown
            const select = document.getElementById('fault-select');
            const option = document.createElement('option');
            option.value = name.toLowerCase().replace(' ', '-');
            option.textContent = name;
            select.appendChild(option);

            input.value = '';
            alert(`Fault type "${name}" added successfully`);
        }

        // Relations management functions
        function addRelation() {
            const equipment = document.getElementById('relation-equipment').value;
            const systems = document.getElementById('relation-systems').value.trim();
            const section = document.getElementById('relation-section').value;
            const faults = document.getElementById('relation-faults').value.trim();

            if (!equipment || !systems || !section || !faults) {
                alert('Please fill in all fields');
                return;
            }

            // Parse comma-separated values
            const systemsList = systems.split(',').map(s => s.trim()).filter(s => s);
            const faultsList = faults.split(',').map(f => f.trim()).filter(f => f);

            const relation = {
                id: Date.now().toString(),
                equipment: equipment,
                systems: systemsList,
                section: section,
                faults: faultsList
            };

            equipmentRelations.push(relation);
            updateRelationsList();
            updateSystemAndFaultDropdowns(systemsList, faultsList);

            // Clear form
            document.getElementById('relation-equipment').value = '';
            document.getElementById('relation-systems').value = '';
            document.getElementById('relation-section').value = '';
            document.getElementById('relation-faults').value = '';

            alert('Relation added successfully');
        }

        function updateSystemAndFaultDropdowns(newSystems, newFaults) {
            // Add new systems to system icons (if not already present)
            newSystems.forEach(system => {
                const systemKey = system.toLowerCase().replace(/\s+/g, '-');
                const existingIcon = document.querySelector(`[data-system="${systemKey}"]`);
                if (!existingIcon) {
                    const iconsContainer = document.querySelector('.system-icons');
                    const newIcon = document.createElement('div');
                    newIcon.className = 'system-icon';
                    newIcon.dataset.system = systemKey;
                    newIcon.textContent = system.charAt(0).toUpperCase() + system.slice(1);
                    newIcon.onclick = function() { selectSystem(this, systemKey); };
                    iconsContainer.appendChild(newIcon);
                }
            });

            // Add new faults to fault dropdown
            const faultSelect = document.getElementById('fault-select');
            newFaults.forEach(fault => {
                const faultValue = fault.toLowerCase().replace(/\s+/g, '-');
                const existingOption = faultSelect.querySelector(`option[value="${faultValue}"]`);
                if (!existingOption) {
                    const option = document.createElement('option');
                    option.value = faultValue;
                    option.textContent = fault;
                    faultSelect.appendChild(option);
                }
            });
        }

        function updateRelationsList() {
            const container = document.getElementById('relations-list');
            
            if (equipmentRelations.length === 0) {
                container.innerHTML = '<p>No relations added yet.</p>';
                return;
            }

            container.innerHTML = '';
            
            equipmentRelations.forEach((relation, index) => {
                const relationItem = document.createElement('div');
                relationItem.className = 'relation-item';
                relationItem.dataset.relationId = relation.id;

                const equipmentName = relation.equipment.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                relationItem.innerHTML = `
                    <div class="relation-actions">
                        ${index > 0 ? '<button class="btn-small btn-up" onclick="moveRelation(' + index + ', -1)">↑</button>' : ''}
                        ${index < equipmentRelations.length - 1 ? '<button class="btn-small btn-down" onclick="moveRelation(' + index + ', 1)">↓</button>' : ''}
                        <button class="btn-small btn-edit" onclick="editRelation(${index})">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteRelation(${index})">Delete</button>
                    </div>
                    <h4>${equipmentName}</h4>
                    <div class="relation-details">
                        <div><strong>Systems:</strong> ${relation.systems.join(', ')}</div>
                        <div><strong>Responsible Section:</strong> ${relation.section.charAt(0).toUpperCase() + relation.section.slice(1)}</div>
                        <div><strong>Probable Faults:</strong> ${relation.faults.join(', ')}</div>
                    </div>
                    <div class="relation-edit-form" id="edit-form-${index}">
                        <select id="edit-equipment-${index}">
                            <option value="">Select Equipment</option>
                            <option value="stack-811">Stack 811</option>
                            <option value="stack-812">Stack 812</option>
                            <option value="stack-813">Stack 813</option>
                            <option value="gg1-filters">GG1 Filters</option>
                            <option value="810-3000">810 3000</option>
                            <option value="810-3100">810 3100</option>
                            <option value="5810800">5810800</option>
                        </select>
                        <input type="text" id="edit-systems-${index}" placeholder="System types (comma separated)" value="${relation.systems.join(', ')}">
                        <select id="edit-section-${index}">
                            <option value="">Select Section</option>
                            <option value="mechanical">Mechanical</option>
                            <option value="electrical">Electrical</option>
                            <option value="operations">Operations</option>
                            <option value="technicians">Technicians</option>
                            <option value="instrumentation">Instrumentation</option>
                            <option value="management">Management</option>
                        </select>
                        <input type="text" id="edit-faults-${index}" placeholder="Probable faults (comma separated)" value="${relation.faults.join(', ')}">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn-primary" onclick="saveRelationEdit(${index})">Save</button>
                            <button class="btn-secondary" onclick="cancelRelationEdit(${index})">Cancel</button>
                        </div>
                    </div>
                `;

                container.appendChild(relationItem);

                // Set the current values in the edit form
                document.getElementById(`edit-equipment-${index}`).value = relation.equipment;
                document.getElementById(`edit-section-${index}`).value = relation.section;
            });
        }

        function editRelation(index) {
            const editForm = document.getElementById(`edit-form-${index}`);
            editForm.style.display = editForm.style.display === 'block' ? 'none' : 'block';
        }

        function saveRelationEdit(index) {
            const equipment = document.getElementById(`edit-equipment-${index}`).value;
            const systems = document.getElementById(`edit-systems-${index}`).value.trim();
            const section = document.getElementById(`edit-section-${index}`).value;
            const faults = document.getElementById(`edit-faults-${index}`).value.trim();

            if (!equipment || !systems || !section || !faults) {
                alert('Please fill in all fields');
                return;
            }

            const systemsList = systems.split(',').map(s => s.trim()).filter(s => s);
            const faultsList = faults.split(',').map(f => f.trim()).filter(f => f);

            equipmentRelations[index] = {
                ...equipmentRelations[index],
                equipment: equipment,
                systems: systemsList,
                section: section,
                faults: faultsList
            };

            updateRelationsList();
            updateSystemAndFaultDropdowns(systemsList, faultsList);
            alert('Relation updated successfully');
        }

        function cancelRelationEdit(index) {
            document.getElementById(`edit-form-${index}`).style.display = 'none';
        }

        function deleteRelation(index) {
            if (confirm('Are you sure you want to delete this relation?')) {
                equipmentRelations.splice(index, 1);
                updateRelationsList();
                alert('Relation deleted successfully');
            }
        }

        function moveRelation(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= equipmentRelations.length) return;

            // Swap relations
            const temp = equipmentRelations[index];
            equipmentRelations[index] = equipmentRelations[newIndex];
            equipmentRelations[newIndex] = temp;

            updateRelationsList();
        }

        // Selection info functions
        function showSelectionInfo() {
            if (selectedTimeBlocks.length === 0) return;

            // Sort blocks by time
            const sortedBlocks = [...selectedTimeBlocks].sort((a, b) => a.time.localeCompare(b.time));
            const startTime = sortedBlocks[0].time;
            const endTime = sortedBlocks[sortedBlocks.length - 1].time;
            
            // Calculate end time (add 5 minutes to the last block)
            const [hours, minutes] = endTime.split(':').map(Number);
            const endMinutes = minutes + 5;
            const finalHours = endMinutes >= 60 ? hours + 1 : hours;
            const finalMinutes = endMinutes >= 60 ? endMinutes - 60 : endMinutes;
            const calculatedEndTime = `${finalHours.toString().padStart(2, '0')}:${finalMinutes.toString().padStart(2, '0')}`;

            const equipmentName = currentEquipment.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            document.getElementById('selected-equipment').textContent = equipmentName;
            document.getElementById('start-time').textContent = startTime;
            document.getElementById('end-time').textContent = calculatedEndTime;
            document.getElementById('selection-info').style.display = 'block';
        }

        function hideSelectionInfo() {
            document.getElementById('selection-info').style.display = 'none';
        }

        // Utility functions
        function getSectionColor(section) {
            switch(section) {
                case 'mechanical': return 'var(--mechanical)';
                case 'electrical': return 'var(--electrical)';
                case 'operations': return 'var(--operations)';
                case 'technicians': return 'var(--technicians)';
                case 'instrumentation': return 'var(--instrumentation)';
                case 'management': return 'var(--management)';
                default: return '#ddd';
            }
        }
    </script>
</body>
</html>
